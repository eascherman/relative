<!DOCTYPE html>
<html>

<head>
	<title>Getting Started</title>
    
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache">

    <script src="relativity.js"></script>
    <script src="templateengine.1.js"></script>

    <script>

        function isString(myVar) {
            return (typeof myVar === 'string' || myVar instanceof String);
        }
        
    </script>

</head>

<body>

    <div id="moreStuff"></div>

    <script>
        
        var o = {};
        R(o, 'a');      // declare o.a as a push notifying variable
        R(o, 'b');
        o.a = 2;
        o.b = 3;
        R(o, 'c', () => o.a + o.b);
 
 
        function randomColor() {
            var r = Math.floor(256 * Math.random());
            var g = Math.floor(256 * Math.random());
            var b = Math.floor(256 * Math.random());
            return `rgb(${r}, ${g}, ${b})`;
        }
 
        function tnRemover() {
            //this.host.removeChild(this.ele);
        }
         
        function listen(name, callback) {       // helper to establish callbacks for events on an element
            return function (ele) {
                if (!ele.evCallbacks)
                    ele.evCallbacks = {};
                if (!ele.evCallbacks[name])
                    ele.addEventListener(name, function(ev) {
                        ele.evCallbacks[name](ev);
                    });
                ele.evCallbacks[name] = callback;
            }
        }
        
        function input(func) {
            return listen('input', ev => func(ev.target.value, ev));
        }
        
        function bind2(obj, prop) {
            return function(ele) {  
                ele.value = obj[prop];
                return input(val => obj[prop] = val);
            }
            return [        // todo: fix attribute handling bugs so this works
                el => el.value = obj[prop],
                input(val => obj[prop] = val)
            ];
        }
        
        var t1 = () => bundle
            `<input type="text" ${ listen('input', ev => o.a = Number(ev.target.value)) }></input>${() => o.a} + ${() => o.b} = ${() => o.c}`;

        var vals = () => bundle 
            `${o.a} + ${o.b} = ${o.c}`;
        var t2 = () => bundle
            `<input type="text" ${() => console.log('hello there!')} ${bind2(o, 'a')} />${vals} end`;
        
        var t3 = el => bundle
            `<div>hello world ${o.a}</div>`;
        
        var rcb = contents => el => bundle
            `<p style="background-color:${randomColor()}">${contents}</p>`;
        
        var t4 = [
            rcb(el => bundle `this is a div with a in it: ${o.a}`),
            rcb(el => bundle `this is a div with b in it: ${o.b}`),
            rcb(el => bundle `this is a div with c in it: ${o.c}`)
        ];
        
        var t5 = el => bundle
            `hello there ${o.a}`;
        
        var t6 = el => bundle
            `hello there ${() => o.c}`;
        
        var t7 = el => bundle
            `${o.a} + ${o.b} = ${o.c}`;
        
        var t8 = el => bundle
            `<div style="background-color: ${randomColor()}; padding:6px;">
                this is a div with a in it: ${() => o.a}
                <div style="background-color: ${randomColor()}; padding:6px;">
                    this is a div with b in it: ${() => o.b}
                    <div style="background-color: ${randomColor()}; padding:6px;">
                        this is a div with c in it: ${() => o.c} <br />
                        a + b = ${() => o.a + o.b}
                    </div>
                </div>
            </div>`;
            
        var t9 = el => [
            () => o.a, 
            o.b, 
            'hello, tree'
        ];
        
        var t11 = () => bundle 
            `a<br />b`;
        
        install(t2, 'moreStuff');     //<<<<<<<<<<<<<<<<<<<



        var textInput = (obj, prop) => el => bundle
            `<input type="text" ${bind2(obj, prop)} />`;
        
        var numberInput = (obj, prop) => el => bundle
            `<input type="number"  ${listen('input', ev => obj[prop] = Number(ev.target.value))} ${el => el.value = obj[prop]} />`
            
        var label = (text, contents) => bundle
            `<div>${text} ${contents}</div>`;
            
        var pli = (obj, prop) => label(prop, textInput(obj, prop));

        function Person(name, age) {
            R(this, 'name');
            this.name = name;
            R(this, 'age');
            this.age = age;
        }

        R(o, 'items');
        o.items = [
            new Person('joe', 13),
            new Person('robin', 59),
            new Person('sam', 24),
            new Person('mary', 44),
        ];
        
        var arrToCells = arr => arr.map(obj => bundle
            `<td>${obj}</td>`
        );
        
        var arrArrToRow = arrArr => 
            arrArr.map(arr => bundle
                `<tr>${arrToCells(arr)}</tr>`
            );
        
        var arrPeople = [
            ['mickey', 88],
            ['mike', 11],
            ['jobo', 55]
        ];
        
        var tableMaker = (header, rows) => () => bundle
            `<table>
                <tr>
                    ${header.map(obj => bundle
                        `<th>${obj}</th>`
                    )}
                </tr>
                ${arrArrToRow(rows)}
            </table>`; 
        
        var gridMaker = items => () => bundle
            `${label("Sam's age:", numberInput(o.items[2], 'age'))}
            ${pli(o.items[2], 'age')}
            <table>
                <tr>
                    <th>Name</th>
                    <th>Age</th>
                </tr>
                ${o.items.map(item => () => bundle
                    `<tr>
                        <td>${() => item.name}</td>
                        <td>${numberInput(item, 'age')}</td>
                        <td>${() => item.age}</td>
                    </tr>`
                )}
            </table>`;
        
        // grid(items)
        // <grid [items]="items"></grid>
        
        var grid = gridMaker(o.items);    
        //grid = tableMaker(['Name', 'Age'], arrPeople);
        
        install(grid, 'moreStuff');

        /*for (var i=0 ; i<1000 ; i++)
            o.a = Math.random()*20;*/
        
/*
        // event bind example

        function listen(name, callback) {       // helper to establish callbacks for events on an element
            return function (ele, context) {
                if (!ele.evCallbacks[context.slot])
                    ele.addEventListener(name, (ev) => ele.evCallbacks[context.slot](ev));
                ele.evCallbacks[context.slot] = callback;
            }
        }

        function click(callback) {
            return listen('click', callback);
        }

        var joe = 'bleh'
        var tt2 = () => bundle
           `<a ${listen('click', (ev) => joe = ev.target.innerHTML)}>
                some test link
            </a>`;
        var tt2 = () => bundle
           `<a ${click(ev => joe = ev.target.innerHTML)}>
                some test link
            </a>`;

        // two way bind example

        function bind2(obj, modelProp) {        // helper to establish 2 way binding on an input element
            return function (ele) {
                listen('input', (ev) => obj[modelProp] = ev.target.value)(ele);
                ele.value = obj[modelProp];
            }
        }

        var mmm = { value: 123 };
        var tt3 = () => bundle
            `<input type="text" value="${() => mmm.value}" ${click(ev => mmm.value = ev.target.value)} />`;
        var tt3 = () => bundle
            `<input type="text" ${(ele) => ele.value = mmm.value} ${click(ev => mmm.value = ev.target.value)} />`;
        var tt3 = () => bundle
            `<input type="text" ${bind2(mmm, 'value')} />`;
            //`<input type="text">${bind2(mmm, 'value')}</input>`;      // less clear but valid
            //`<input type="text" [(ngModel)]="mmm.value" />`;          // angular 2 comparison

        var dynField = (getter, setter) => (ele) => bundle
            `<input type="text" ${listen('input', setter(ele.value))} ${(ele) => ele.value = getter()} />`;
        var val1;
        var field1 = dynField(() => val1, (val) => val1 = val);

        var dynFieldSimple = (obj, param) => (ele) => bundle
            `<input type="text" ${bind2(obj, param)} />`;
        var holder = {};
        var field1 = dynFieldSimple(holder, 'value');
        */
    </script>
</body>

</html>