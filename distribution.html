<html>
<head>
    <title>Distribution</title>
    <script src="changedetection.js"></script>
    <script src="templateengine.js"></script>
    <script src="toolkit.js"></script>
</head>

<body></body>

<script>
    var data = {};

    function Point(x, y) {
        this.x = x;
        re(this, 'x');
        this.y = y;
        re(this, 'y');
    }
    Point.prototype.delta = function(p) {
        return {
            dx: this.x - p.x,
            dy: this.y - p.y
        };
    };

    function Distribution() {
        re(this, 'rawPoints');
        this.rawPoints = [];

        re(this, 'rawArea', function() {
            var rawPoints = this.rawPoints;
            var area = rawPoints.reduce(function(p, i) {
                if (i == 0)
                    return 0;
                else {
                    var prior = rawPoints[i-1];
                    var dx = p.x - prior.x;
                    var da = (p.y + prior.y) * dx / 2;
                    return da; 
                }
            }, 0);
            return area;
        });

        re(this, 'points', function() {
            var area = this.rawArea;
            //this.rawPoints.map(p => new Point(p.x, p.y / area));
            return this.rawPoints.map(rp => {
                var p = {};
                re(p, 'x', () => rp.x, val => rp.x = val);
                re(p, 'y', () => rp.y / this.rawArea, val => rp.y * this.rawArea);
            });
        });
    }
    Distribution.prototype.scalePoints = function(xMin, yMin, xMax, yMax) {
        var rps = this.rawPoints;
        return rps.map(rp => {
            var xRange = xMax - xMin;
            var yRange = yMax - yMin;

            var xMinPoint = rps[0].x;
            var xMaxPoint = rps[rps.length-1].x;
            var yMinPoint = 0;
            var yMaxPoint = rps.reduce((acc, mp) => Math.max(acc, mp.y), 0);

            var xPointRange = xMaxPoint - xMinPoint;
            var yPointRange = yMaxPoint - yMinPoint;

            var xScale = xRange / xPointRange;
            var yScale = yRange / yPointRange;

            var p = {};
            re(p, 'x', () => (rp.x - xMinPoint) * xScale + xMin, 
                val => rp.x = (val - xMin) / xScale + xMinPoint);
            re(p, 'y', () => (rp.y - yMinPoint) * yScale + yMin, 
                val => rp.y = (val - yMin) / yScale + yMinPoint);

            return p;
        });
    };

    re(data, 'dist');
    data.dist = new Distribution();
    data.dist.rawPoints = [
        new Point(-10,0),
        new Point(-6,2),
        new Point(-1,9),
        new Point(0,10),
        new Point(1,9),
        new Point(6,2),
        new Point(10,0)
    ];

    var vScale = 100;
    var bot = 10;
    var drawLine = (x1, y1, x2, y2, floor) => {
        y1 *= 100;
        y2 *= 100;
        floor *= 100;
        return re.bundle
            `<polygon points="${x1},${floor} ${x1},${y1} ${x2},${y2} ${x2},${floor}" 
                style="fill:rgba(0,0,200,0.3)" />
            <line x1="${x1}" x2="${x2}" y1="${y1}" y2="${y2}" 
                style="stroke:rgb(205,0,0); stroke-width:0.5" />`;
    };

    var min = (a, b) => Math.min(a, b);
    var max = (a, b) => Math.max(a, b);

    var drawPath = points => {
        console.log('draw path');

        var polygonPoints = points.map(p => `${p.x},${p.y} `);
        var pathPoints = 'M' + points.map(p => `${p.x} ${p.y}`).join(' L ');

        var draggedPoint, xDragStart, yDragStart, xPointStart, yPointStart;
        var onDragStart = p => ev => {
            var root = ev.target.parentElement;
            xDragStart = ev.clientX;
            yDragStart = ev.clientY;
            xPointStart = p.x;
            yPointStart = p.y;
            
            function mouseMove(ev) {
                console.log('mouse move');
                p.x = xPointStart + ev.clientX - xDragStart;
                p.y = yPointStart + ev.clientY - yDragStart;
            }
            function mouseUp(ev) {
                console.log('mouse up');
                root.removeEventListener('mousemove', mouseMove);
                root.removeEventListener('mouseup', mouseUp);
            }
            console.log('mouse down');
            root.addEventListener('mousemove', mouseMove);
            root.addEventListener('mouseup', mouseUp);
        };

        return re.bundle
            `<polygon points="${polygonPoints}" 
                style="fill:rgb(200,200,200)" />
            <path d="${pathPoints}" fill="transparent"
                style="stroke:rgb(100,0,0); stroke-width:1.5" />
            ${points.map(p => re.bundle
                `<circle cx="${() => p.x}" cy="${() => p.y}" r="3" fill="white" draggable="true"
                    style="stroke:rgb(50,50,50); stroke-width:1.5" 
                    ${re.on.mousedown(onDragStart(p))} />` 
            )}`;
    };

    var drawDistributionChart = distribution => {
        console.log('draw chart');

        var padding = 10;
        var xChartSize = 600;
        var yChartSize = 400;
        var xChartMin = padding;
        var yChartMin = padding;
        var xChartMax = xChartSize - padding;
        var yChartMax = yChartSize - padding;
        /*
        var points = distribution.rawPoints;

        var xs = points.map(p => p.x);
        var ys = points.map(p => p.y);
        var yMin = ys.reduce(min, 0);
        var yMax = ys.reduce(max, 0);
        var xMin = xs.reduce(min, 0);
        var xMax = xs.reduce(max, 0);
        var xRange = xMax - xMin;
        var yRange = yMax - yMin;

        var xChartRange = xChartMax - xChartMin;
        var yChartRange = yChartMax - yChartMin;
        var xScale = xChartRange / xRange;
        var yScale = yChartRange / yRange;
        
        var chartPoints = points.map(p => new Point(
            xChartMin + (p.x - xMin) * xScale, 
            yChartMax - (p.y - yMin) * yScale
        ));
        */
        var chartPoints = distribution.scalePoints(xChartMin, yChartMax, xChartMax, yChartMin);

        return re.bundle 
            `<svg width="600" height="400" preserveAspectRatio="none" 
                    viewBox="0 0 ${xChartSize} ${yChartSize}">
                ${() => drawPath(chartPoints)}
            </svg>`;
    };

    var chart = drawDistributionChart(data.dist);

    re.install(chart, document.body);
</script>

</html>